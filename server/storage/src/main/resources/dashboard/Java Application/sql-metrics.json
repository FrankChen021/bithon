{
  "id": "sql-metrics",
  "title": "SQL",
  "filter": {
    "selectors": [
      {
        "type": "datasource",
        "name": "sql-metrics",
        "fields": [
          {
            "name": "appName",
            "width": 200,
            "allowClear": false
          },
          "instanceName",
          "server",
          "database",
          "sqlType"
        ]
      }
    ]
  },
  "charts": [
    {
      "title": "TPS",
      "width": 4,
      "type": "line",
      "columns": [
        {
          "name": "tps",
          "yAxis": 0
        },
        {
          "name": "callCount",
          "yAxis": 1
        }
      ],
      "query": {
        "type": "timeseries",
        "dataSource": "sql-metrics",
        "fields": [
          {
            "name": "tps",
            "expression": "round(sum(callCount)/{interval}, 2)"
          },
          {
            "name": "callCount",
            "expression": "sum(callCount)"
          }
        ]
      },
      "details": {
        "columns": ["database", "sqlType", "tps", "callCount"],
        "query": {
          "type": "groupBy",
          "fields": [
            {
              "name": "tps",
              "expression": "round(sum(callCount)/{interval}, 2)"
            },
            {
              "name": "callCount",
              "expression": "sum(callCount)"
            }
          ],
          "groupBy": ["database", "sqlType"],
          "orderBy": {
            "name": "callCount",
            "order": "desc"
          }
        },
        "tracing": {
          "mappings": {
            "sqlType": "tags['db.operation.name']"
          },
          "filter": "kind = 'CLIENT'"
        }
      }
    },
    {
      "title": "Response Time",
      "width": 2,
      "type": "line",
      "yAxis": [
        {
          "format": "nanoFormatter"
        }
      ],
      "columns": ["minResponseTime", "avgResponseTime", "maxResponseTime"],
      "query": {
        "type": "timeseries",
        "dataSource": "sql-metrics",
        "fields": [
          {
            "name": "minResponseTime",
            "expression": "min(minResponseTime)"
          },
          {
            "name": "avgResponseTime",
            "expression": "round(sum(responseTime) * 1.0 /sum(callCount),2)"
          },
          {
            "name": "maxResponseTime",
            "expression": "max(maxResponseTime)"
          }
        ]
      },
      "details": {
        "columns": [
          "database",
          "sqlType",
          "callCount",
          {
            "name": "minResponseTime",
            "format": "nanoFormatter"
          },
          {
            "name": "avgResponseTime",
            "format": "nanoFormatter"
          },
          {
            "name": "maxResponseTime",
            "format": "nanoFormatter"
          }
        ],
        "query": {
          "type": "groupBy",
          "fields": [
            {
              "name": "callCount",
              "expression": "sum(callCount)"
            },
            {
              "name": "minResponseTime",
              "expression": "min(minResponseTime)"
            },
            {
              "name": "avgResponseTime",
              "expression": "round(sum(responseTime) * 1.0 /sum(callCount),2)"
            },
            {
              "name": "maxResponseTime",
              "expression": "max(maxResponseTime)"
            }
          ],
          "groupBy": ["database", "sqlType"],
          "orderBy": {
            "name": "avgResponseTime",
            "order": "desc"
          }
        }
      }
    },
    {
      "title": "IO",
      "width": 2,
      "type": "line",
      "yAxis": [
        {
          "format": "binary_byte"
        }
      ],
      "columns": ["bytesOut"],
      "query": {
        "type": "timeseries",
        "dataSource": "sql-metrics",
        "fields": [
          {
            "name": "bytesOut",
            "expression": "sum(bytesOut)"
          }
        ]
      },
      "details": {
        "columns": [
          "database",
          "sqlType",
          {
            "name": "bytesOut",
            "format": "binary_byte"
          }
        ],
        "query": {
          "type": "groupBy",
          "fields": [
            {
              "name": "bytesOut",
              "expression": "sum(bytesOut)"
            }
          ],
          "groupBy": ["database", "sqlType"],
          "orderBy": {
            "name": "bytesOut",
            "order": "desc"
          }
        }
      }
    },
    {
      "title": "Slow SQLs",
      "width": 4,
      "type": "table",
      "columns": [
        {
          "name": "timestamp",
          "format": "time",
          "template": "MM-dd hh:mm:ss.S",
          "sortable": true
        },
        "server",
        "database",
        {
          "name": "responseTime",
          "format": "nanosecond",
          "sortable": "true"
        },
        { "name": "statement", "format": "sql" },
        {
          "name": "traceId",
          "format": "template",
          "template": "<a target='_blank' href='/web/trace/detail?_sidebar=collapsed&id={traceId}&type=trace'>{traceId}</a>"
        }
      ],
      "query": {
        "dataSource": "sql-metrics",
        "type": "list",
        "fields": ["timestamp", "server", "database", "responseTime", "statement", "traceId"],
        "limit": "10",
        "orderBy": {
          "name": "responseTime",
          "order": "desc"
        },
        "filter": "statement <> ''",
        "precondition": {
          "filters": ["appName"]
        }
      }
    }
  ]
}
