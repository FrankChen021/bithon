<!DOCTYPE HTML>
<html lang="zh_CN"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_common/layout}">
<head>
    <title>Bithon Tracing Logs</title>

    <!-- tree grid style -->
    <link rel="stylesheet" type="text/css" th:href="@{/lib/jquery-treegrid-0.2/css/jquery-treegrid.min.css}"/>
    <script th:src="@{/lib/sql-formatter-4.0.2/sql-formatter.min.js}"></script>

    <script th:src="@{/lib/echarts5.0.1/echarts.min.js}"></script>
    <script th:src="@{/js/chart-component.js}"></script>
    <script th:src="@{/js/component/tree-table/component.js}"></script>
    <script th:src="@{/js/utils/location.js}"></script>

    <style>
        .tag-value {
            /* CSS 3 */
            white-space: -o-pre-wrap;
            word-wrap: break-word;
            white-space: pre-wrap;
            white-space: -moz-pre-wrap;
        }
    </style>
</head>
<body>
<div style="padding-top:15px; padding-left: 5px; padding-right: 5px" layout:fragment="content">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="header">
        <!-- Navbar content -->
        <a class="navbar-brand" href="/web/home">Bithon</a>
    </nav>
    <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="pills-trace-tab" data-toggle="tab" href="#pills-trace" role="tab"
               aria-controls="pills-trace" aria-selected="true">Trace</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-map-tab" data-toggle="tab" href="#pills-map" role="tab"
               aria-controls="pills-map" aria-selected="false">Map</a>
        </li>
        <li class="nav-item" id="tool-bar" style="position: absolute; right: 0; margin-right: 5px">
            <button class="btn btn-link" onclick="javascript: loadSpanLog()">Reload</button>
        </li>
    </ul>
    <div class="tab-content">
        <div class="tab-pane show active" id="pills-trace" role="tabpanel" aria-labelledby="pills-trace-tab">
        </div>
        <div class="tab-pane fade" id="pills-map" role="tabpanel" aria-labelledby="pills-map-tab">
        </div>
    </div>

    <script>
        let interval = window.queryParams['interval'];
        if (interval != null) {
            const parts = decodeURIComponent(interval).split('/');
            interval = {
                start: parts[0],
                end: parts[1]
            };
        } else {
            //interval maybe undefined
            interval = null;
        }

        if (window.queryParams['embedded'] === '1') {
            $('#header').css('display', 'none');

            let href = window.location.origin + window.location.pathname + '/?';
            $.each(window.queryParams, (name, val) => {
                // Remove the 'embedded param
                if (name !== 'embedded')
                    href += `${name}=${val}&`;
            });
            $('#tool-bar').append(
                `<a target="_blank" href="${href}" class="btn btn-link">Open</a>`
            );
        } else {
            $('#pills-tab').css('padding-top', '50px');
        }

        let traceData = [];
        const vTreeTable = new TreeTable('#pills-trace', {
            treeColumn: 3,
            headerStyle: 'thead-light',
            rowStyle: (rows, rowIndex) => {
                if (rowIndex === 0
                    || rows[rowIndex].appName !== rows[rowIndex - 1].appName
                    || rows[rowIndex].instanceName !== rows[rowIndex - 1].instanceName
                ) {
                    return 'table-active';
                }
                return null;
            },
            columns: [{
                field: '__levelId',
                title: 'No',
                formatter: (value, row, index) => (index + 1)
            }, {
                field: 'appName',
                title: 'Application'
            }, {
                field: 'instanceName',
                title: 'Instance'
            }, {
                field: 'name',
                title: 'Component'
            }, {
                field: 'clazz',
                title: 'Method',
                formatter: function (value, row) {
                    if (row.clazz === "") {
                        return row.method;
                    } else {
                        // clazz holds the full qualified class name, here, display the simple class name

                        // first check if the name is with generic type info, these names are typically in some c++ applications
                        const braceIndex = row.clazz.lastIndexOf('<');
                        const lastDotIndex = row.clazz.lastIndexOf('.', braceIndex === -1 ? row.clazz.length - 1 : braceIndex);
                        const text = lastDotIndex > 0 ? row.clazz.substring(lastDotIndex + 1) + '.' + row.method : (row.clazz + '.' + row.method);
                        return text.replace("<", "&lt;").replace(">", "&gt;");
                    }
                }
            }, {
                field: 'costTime',
                title: 'Duration',
                formatter: function (value, row) {
                    return microFormat(value);
                }
            }, {
                field: 'startTime',
                title: 'Start Time',
                width: 140,
                formatter: function (value, row) {
                    // start time is in micro-second
                    return new Date(value / 1000).format('MM-dd hh:mm:ss.S');
                }
            }, {
                field: 'tags',
                title: 'Tags',
                formatter: function (value, row, globalRowIndex) {
                    let text = '<pre style="margin-bottom: 0">';
                    for (const propName in value) {
                        const propVal = value[propName];
                        const returnPos = propVal.indexOf('\n');
                        if (propName !== 'uri' && propName !== 'query_id' && (propVal.length > 30 || returnPos !== -1)) {
                            const truncateIndex = returnPos !== -1 ? Math.min(returnPos, 30) : 30;
                            text += `<b>${propName}</b>: ${propVal.substring(0, truncateIndex)}<a href="javascript:showTags(${globalRowIndex}, '${propName}')" class="badge badge-info">...</a><br/>`;
                        } else {
                            text += `<b>${propName}</b>: ${propVal}<br/>`;
                        }
                    }
                    text += '</pre>';

                    return text;
                }
            }]
        });

        function loadSpanLog() {
            vTreeTable.load({
                url: apiHost + '/api/trace/getTraceById',
                method: 'post',
                contentType: "application/json",
                data: () => {
                    return {
                        id: window.queryParams['id'],
                        type: window.queryParams['type'],
                        startTimeISO8601: interval === null ? null : interval.start,
                        endTimeISO8601: interval === null ? null : interval.end,
                        hierachy: true
                    };
                },
                responseHandler: (data) => {
                    traceData = data;
                    return data.spans;
                },
                getChildren: (span) => span.children
            });
        }

        loadSpanLog();

        function toTraceMapOption(map) {
            return {
                animationDurationUpdate: 1000,
                animationEasingUpdate: 'quinticInOut',
                series: [
                    {
                        type: 'graph',
                        layout: 'none',
                        symbolSize: 50,
                        roam: true,
                        label: {
                            show: true,
                            position: 'bottom'
                        },
                        edgeSymbol: ['circle', 'arrow'],
                        edgeSymbolSize: [4, 10],
                        edgeLabel: {
                            fontSize: 20
                        },
                        data: map.nodes.map(node => {
                            return {
                                name: node.name,
                                x: 50 * (node.level + 1),
                                y: 50 * (node.levelIndex + 1),
                                //symbol: `image:///images/nodes/${node.type.toLowerCase()}.png`
                            };
                        }),
                        links: map.links.map(link => {
                            return {
                                // minRT: link.minResponseTime,
                                // maxRT: link.maxResponseTime,
                                // avgRT: link.avgResponseTime,
                                callCount: link.count,
                                source: link.source,
                                target: link.target,
                                label: {
                                    show: true,
                                    formatter: (val) => {
                                        return `${val.data.callCount}`;
                                        //, Min:${nanoFormat(val.data.minRT)}, Max:${nanoFormat(val.data.maxRT)}, Avg:${nanoFormat(val.data.avgRT)}`;
                                    },
                                    fontSize: 10
                                },
                                lineStyle: {
                                    curveness: 0
                                }
                            };
                        }),
                        lineStyle: {
                            opacity: 0.9,
                            width: 2,
                            curveness: 0
                        }
                    }
                ]
            };
        }

        let chartLoaded = false;
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (!e.target.href.endsWith('-map')) {
                return;
            }
            if (chartLoaded) {
                return;
            }

            let mapComponent = new ChartComponent({
                containerId: 'pills-map',
                height: '600px'
            }).header('Trace Map');
            mapComponent.setChartOption(toTraceMapOption(traceData.map));
            chartLoaded = true;
        })

        function showTags(index, propName) {
            const span = vTreeTable.getRowData()[index];

            let text = span.tags[propName];
            if (propName === 'sql'
                ||
                // temporary compatible with old span Druid span data
                (span.method === 'doPost' && propName === 'query' && span.clazz.endsWith("SqlResource"))
                ||
                // temporary compatible with old clickhouse span data
                (span.method === 'query' && propName === 'statement')
            ) {
                try {
                    text = window.sqlFormatter.format(text);
                } catch (e) {
                }
                text = `<pre>${text}\n</pre>`;
            } else if (propName === 'http.uri') {
                text = toShowContent(text.trim());
            } else {
                text = `<pre>${text}\n</pre>`;
            }
            bootbox.dialog({
                centerVertical: true,
                size: 'xl',
                onEscape: true,
                backdrop: true,
                message: text
                // buttons: {
                //     copy: {
                //         label: "Copy",
                //         className: 'btn-info',
                //         callback: function () {
                //             const valueView = document.getElementById('tagValueView');
                //             valueView.select();
                //             document.execCommand('copy');
                //             return false;
                //         }
                //     }
                // }
            });
        }

        function toShowContent(url) {
            const idx = url.indexOf('?');
            if (idx === -1) {
                return `<pre>${url}\n</pre>`;
            }

            const path = url.substring(0, idx);
            const params = url.substring(idx + 1);
            if (params.length === 0) {
                return `<pre>${url}\n</pre>`;
            }

            const pairs = [];
            const paramPairs = params.split("&");
            for (let i = 0; i < paramPairs.length; i++) {
                const pair = paramPairs[i].split("=");
                const name = pair[0].trim();
                const value = decodeURIComponent(pair[1]);
                if (name === '') {
                    continue;
                }

                pairs.push({name: name, value: value});
            }
            pairs.sort((l, r) => {
                if (l.name > r.name)
                    return 1;
                if (l.name === r.name)
                    return 0;
                return -1;
            })

            let content = `<div>Path: ${path}</div>` + "<table class='table table-sm' style='table-layout: fixed; width: 100%'><tbody>";
            pairs.forEach((p) => {
                content += `<tr><td style="width: 10%">${p.name}</td><td class="tag-value">${p.value}</td></tr>`;
            });
            return content + "</tbody></table><br/>"
        }
    </script>
</div>
</body>
</html>